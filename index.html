<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb.min.js?v=1.1.41"></script>
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb-mnemonic.min.js?v=1.1.41"></script>
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <div id="main">
      <div id="timer-bg-top"></div>
      <div id="timer-stats">
        <div id="timer-stats-names">
          <div class="timer-stat">адрес таймера</div>
          <div class="timer-stat">баланс таймера</div>
          <div class="timer-stat">запланировано сообщений</div>
        </div>
        <div id="timer-stats-values">
          <div class="timer-stat" id="addr"><b>?</b></div>
          <div class="timer-stat" id="balance"><b>-.- TON</b></div>
          <div class="timer-stat" id="schedules"><b>?</b></div>
        </div>
      </div>
      <div id="timer-use">
        <input type="datetime-local" id="schedule-at" placeholder="дд.мм.гггг, --:--">
        
        <input type="text" placeholder="Адрес для отправки сообщения" id="schedule-addr">
        <input type="text" placeholder="Количество TON для прикрепления" id="schedule-value">
        
        <input type="radio" id="send-text" name="send" checked>
        <label for="send-text">Послать текст</label>
        <input type="radio" id="send-boc" name="send">
        <label for="send-boc">Послать bag-of-cells</label>
        
        <input type="text" placeholder="Текст/BOC сообщения" id="schedule-body">
        
        <div id="timer-result-link" class="err">
          Некорректная дата
        </div>
      </div>
      <div id="timer-bg-bottom"></div>
    </div>
    
    <script>
      let $ = document.querySelector.bind(document);
      const tonweb = new TonWeb(
        new TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC')
      );
      
      let requests = [];
      let last_finish = 0;
      setInterval(() => {
        if (requests.length && Date.now() - last_finish > 1600) {
          const req = requests.pop();
          console.log(req);
          
          last_finish = Date.now() + 86400 * 1000;
          req.fn(...req.args).then((...args) => {
            last_finish = Date.now();
            
            return req.onresult(...args);
          }, () => {last_finish = Date.now();});
        }
      }, 100);
      
      class Timer extends tonweb.Contract {
        constructor(provider, options) {
          // build/boc/contract-timer.hex
          options.code = tonweb.boc.Cell.oneFromBoc('B5EE9C7201021C010004A7000114FF00F4A413F4BCF2C80B01020120020302014804050002F20202CB0607020120161704C1D007434C0FE900C234219FE4420404400000000000000000000000000000000000000000000000000000003148431C16517C13C0478005C6C2497C0F80875D270482497C0F80074C7C8608401FAF2316EB8C08860843505B703EEB8C0A244F1C1608090A0B029BA0F6A268698F90FC11DDC75798E98000E0007968414108399DF043B8400C64658281FD201809E78B410802FAF0807D010965B5658FED9E64B87D80474498420FDCC7416D9E6F7140805A7F1018401415027831325202DB3CED44D0D31F22D70B1F12BDF2D078D30001C000F2D07901D31F30C8CB1F01FA405214C705F2D07ACF1601D459CF1401CF16C9ED54DB3C0C15028431325202DB3CED44D08020D721D30001F2E07EFA4003C705F2E07F20841F01D300018E8D31FA40318040D721D31F30DB3C9130E202D43002C8CB1F01CF16CCC9ED540C1500438002B7C7862E322201377988E7A0FB1F8579818E325FDA446EE33B44ADC0FF4F291002FE8EDF6C12AA1F01D31F30A020C0018E8330DB3CE0F8276F2230841FF823A15112A182083719E758A8B9F2D069708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1658FA02CB6AC970FB00E08210F5431AA5BDF2D08CD31FD33F218208989680B9F2D06482081B8CF4150D01E8D30001C000955BF2C0726DE001D30A018309BDF2D06E01D4D4ED44D022F90001D430F900BDF2D0725222DB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F82812C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED3000197FA40318060D721DE301301B67024F823A1B609A822A0821017D78400A014B9F2D065833FF81103FA40D430DB3C708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1682100BEBC200FA02CB6AC971FB000E038CED44D0D31F5315B60802841FBA8E82DB3CDED47103C8CB1F13CB0002D30001C0018E9B30830958CB0AF828275147041037461626DB3C58CBFF13CB3FCB1FE30D01CF14C9ED54150F10011070C8CB01C901DB3C1102B0FA40D33F5391BAF2D12C5319BC8EC7C801D31F305309B98E107158CB005003CF16CB3FCB1F7001CB009C7158CB015003CF16CB3FCB1FE283095003CB0AF82803C92851580510481037541028DB3C01CBFF13CB3FCB1FE30D1112016E07C8CB3F16CB1F14CB3F58CF16CC01CF165210CCCCC901DB3C7621F90083098010C8CB05CB0ACBFF70FA02CB6B5210CCC98040FB00F90013016E5142CF16CB3F5003CF168210FBFFAB22708018C8CB055005CF1624FA0214CB6A13CB1F17CB3F15CB1F13CB3F01CF16CCDB3CC98040FB0014000E76C8CB04CCCCC90014ED44D0D4307058CB00CC0074708018C8CB058D0867F9108101100000000000000000000000000000000000000000000000000000000CCF1682101DCD6500FA02CB6AC970FB000201201819001DBC82DBFB836C10085AEF6A1EC45814001FB8B5D316EF2E0646D70C8CB01F400C980201201A1B0027B5D2DDA89A10041AE43A6000327F48061C060DB00017B4F47061391961597FF93A10');
          super(provider, options);
        }
        
        createDataCell() {
          const cell = new tonweb.boc.Cell();
          cell.bits.writeUint(0xFFFFFFFF, 32);  //  no scheduled messages
          cell.bits.writeUint(0, 1);            //  no bells
          
          // build/boc/contract-bell.hex
          cell.refs.push(tonweb.boc.Cell.oneFromBoc('B5EE9C72010227010005F8000114FF00F4A413F4BCF2C80B0102016202030202CC04050201200A0B01CDD9910E38048ADF068698180B8D848ADF000E98F90C108399DF043DD4E9880FD201800C10093A676A1EC475D10C1087DFFD5915D474918E99FE98FE99FFD206A037D20182AA86D9E470D80C1084B7AE43ADD4E00FD201800C100D8B976A1EC4A2DF960CA71717141D02012006070029F4184B8E4658065850A65FF89659FE58F80E78B64C0201480809002520C25C540172C00532C284B2FFF2CFF2C7F26000213B513420402835C87E900C750C7E900C200201200C0D02012016170201200E0F0105BA687815020158101103D7B4E9841AE1600A445B679DA89A10081AE43A63FA67FF481A9F48063A861A1A6000380031D4E6CBE08650420E677C10EE1003191960A07F48060279E2C45F4042596D5963E03B679930081F601C1F046A00B77E5A0C8E3002191960AA0079E2CA007F40596D59992E1F6000501E23140105AEA8C0120105AF70C013008CF828FA44317082100DD607E3218018C8CB055009CF1622FA0218CB6A17CB1F13CB3F12CBFF01CF16F00DCF1612CC12CB3F01987101CB00ED4401CC947001CB00E2C98040FB000056F828FA443182108B771735708018C8CB055005CF1624FA0214CB6A13CB1FCB3FCBFFF00DCF16C98040FB00029E8EA5821096F5C875708010C8CB055005CF1624FA0214CB6A13CB1F58DB3C01CF16C98100A0FB008EA58210D416DC0F708010C8CB055005CF1624FA0214CB6A13CB1F58DB3C01CF16C98100A0FB00E223230090F828FA44317082102233223382100F24C7AE228018C8CB055008CF1623FA0217CB6A16CB1F15CB3FCBFFF00DCF1612CC12CB3F01987101CB00ED44CF14947001CB00E2C98040FB0002012018190201201B1C001DB5F9FF051F48863E01AFEA82440DB003F9B62E4CDB67803A60003E5C325A803A003A863DA89A1904409AE16BF083F6045AE16BF083F600BA600031C2BF480630081AE4241AE163E2D73E5A32609AE163E092261C504200FD7918AE1002191960BE01B9E2C43F40596D5963EA00DB6782B963E27963F92E1F60003A73E07973E05F480A0679E2C05A8A0679E280501E231A0054FA405033CF1602D401D0D3000197FA40318060D721DEC85003CF1658CF16C912CF1401D430CF14C9ED540105B79CB01D0029B46FDDA89A10081AE43A63FA67FF481A9F481A8610037E5065DB3CED44D0D33F5252BCF2D06423F823B9F2D0656D01D401D001D31F305250B9E30F206EB38E13ED44D0D4D431D4C801CF1612CC12CCCCC9ED549130E21E1F2001D4D30001C0009AF00D12C705F2E072D430E001D30A018309BDF2D06E01D4D4305CDB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F00D12C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED3000197FA40318060D721DE302603BCD30001C0008E9231F00D255150050410394880DB3C5023F00B8F42FA4020D70B3F5270BC8EB5308210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE222232103FEC801D30001C000947058CB008E107158CB0001FA4059CF1601D35F02CB5FE201D30001C0008E923031F00D255150050410394880DB3C02F00C8F43FA4020D70B3F5280BC8EB630318210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE2222324018232C822D70B5F841FB05260BB947001CB00DE7101CB0001CF1601D35F02CB5F21D70B5F841FB05250BC947001CB00DEC9F00D2651600605104A1913DB3C5023F00B25011070C8CB01C901DB3C2500527158CB00ED44D0D4D39F01C8CB9F01FA4059CF1612CC01FA4059CF1601D431D4305202CCCCC901CCCC018433C823D70B5F841FB05270BB947001CB00DE7101CB0001CF1602D35F03CB5F02D70B5F841FB05250BC957058CB0001DE01C9F00D2651600605104A1913DB3C02F00C25016E07C8CB3F16CB1F14CB3F58CF16CC01CF165210CCCCC901DB3C7621F90083098010C8CB05CB0ACBFF70FA02CB6B5210CCC98040FB00F90026000E76C8CB04CCCCC9'));
          return cell;
        }
      }
      
      const timer = new Timer(tonweb, {});
      
      async function update_wallet_info_timer() {
        let addr = await timer.getAddress();
        
        requests.push({
          'fn': tonweb.getBalance.bind(tonweb),
          'args': [addr],
          'onresult': (v) => {
            $('.timer-stat#balance>b').innerText = v / 1000000000 + ' TON';
          }});
        
        requests.push({
          'fn': tonweb.provider.getExtendedAddressInfo.bind(tonweb.provider),
          'args': [addr.toString(true)],
          'onresult': (v) => {
            if (v.account_state['@type'] == 'uninited.accountState') {
              $('.timer-stat#schedules>b').innerText = '0 (timer not deployed yet)';
            } else {
              let dict = tonweb.boc.Cell.oneFromBoc(tonweb.utils.base64ToBytes(v.account_state.data));
              
              let count_refs = (cell) => {
                let n = 0;
                for (let c in cell.refs) {
                  n += count_refs(c) + 1;
                }
                return n;
              };
              
              let r = count_refs(dict);
              $('.timer-stat#schedules>b').innerText = (r ? '(?) ' : '') + r / 3;
            }
          }});
      }
      
      // timer.deploy().then(console.log)
      
      function _promise_recalc_schedule_link(resolve, reject) {
        let d = $('#schedule-at').valueAsDate;
        if (d == null)      {return reject('Некорректная дата');}
        if (d < new Date()) {return reject('Эта дата уже прошла');}
        
        let timer_work_s = Math.floor((d - new Date()) / 1000) + 5;
        
        let e = $('#schedule-value').value;
        let nano_ton_schedule = Math.max(tonweb.utils.toNano(e) * 1, 10000000);
        let nano_ton = nano_ton_schedule + 1805556 * timer_work_s + 450000000;
        
        // may throw address parsing exception
        let a = new tonweb.Address($('#schedule-addr').value);
        let schedule_addr = new tonweb.boc.Cell();
        schedule_addr.bits.writeAddress(a);
        
        let schedule_body = null;
        if ($('#send-boc').checked) {
          schedule_body = tonweb.boc.Cell.oneFromBoc($('#schedule-body').value);
        } else {
          schedule_body = new tonweb.boc.Cell();
          schedule_body.bits.writeUint(1, 64);
          schedule_body.bits.writeString($('#schedule-body').value);
        }
        
        let body = new tonweb.boc.Cell();
        body.bits.writeUint(nano_ton_schedule, 64);
        body.bits.writeUint(Math.floor(d.getTime() / 1000), 32);
        body.refs.push(schedule_addr);
        body.refs.push(schedule_body);
        
        (async () => {
          let timer_addr = await timer.getAddress();
          let boc = await body.toBoc();
          
          let tonhub_link = 'https://tonhub.com/transfer/';
          tonhub_link += timer_addr.toString(true, true, true);
          tonhub_link += '?amount=' + nano_ton;
          tonhub_link += '&bin=' + tonweb.utils.bytesToBase64(boc);
          
          let tonkeeper_link = 'https://app.tonkeeper.com/transfer/';
          tonkeeper_link += timer_addr.toString(true, true, true);
          tonkeeper_link += '?amount=' + nano_ton;
          tonkeeper_link += '&bin=' + tonweb.utils.bytesToBase64(boc);
          
          let ton_link = 'ton://transfer/';
          ton_link += timer_addr.toString(true, true, true);
          ton_link += '?amount=' + nano_ton;
          ton_link += '&bin=' + tonweb.utils.bytesToBase64(boc);
          
          return 'Требуемая сумма: ' + nano_ton / 1000000000 + ' TON<br><br>'
               + '<a href="' + tonhub_link    + '">Tonhub</a><br>'
               + '<a href="' + tonkeeper_link + '">Tonkeeper</a><br>'
               + '<a href="' + ton_link       + '">TON</a><br><br>'
               + '<div style="font-size: 14px">' + tonhub_link    + '</div>'
               + '<div style="font-size: 14px">' + tonkeeper_link + '</div>'
               + '<div style="font-size: 14px">' + ton_link       + '</div>';
        })().then(resolve);
      }
      
      function recalc_schedule_link() {
        let link_div = $('#timer-result-link');
        
        (new Promise(_promise_recalc_schedule_link)).then(
          (link) => {link_div.classList.remove('err'); link_div.innerHTML = link;},
          (err)  => {link_div.classList.add('err');    link_div.innerText = '' + err;}
        );
      }
      
      recalc_schedule_link();
      update_wallet_info_timer();
      $('#schedule-at').oninput = recalc_schedule_link;
      $('#schedule-addr').oninput = recalc_schedule_link;
      $('#schedule-value').oninput = recalc_schedule_link;
      $('#send-text').oninput = recalc_schedule_link;
      $('#send-boc').oninput = recalc_schedule_link;
      $('#schedule-body').oninput = recalc_schedule_link;
      
      setInterval(recalc_schedule_link, 5000);
      setInterval(update_wallet_info_timer, 5000);
      
      (async () => {
        $('.timer-stat#addr>b').innerText = (await timer.getAddress()).toString(true, true, true);
      })();
    </script>
  </body>
</html>