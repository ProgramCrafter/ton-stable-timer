<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb.min.js?v=1.1.41"></script>
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb-mnemonic.min.js?v=1.1.41"></script>
    
    <script>
      const tonweb = new TonWeb(
        new TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC')
      );
      
      // Intentional secret leakage.
      // This seed can only be used for testing timer.
      const seed  = [75,5,181,210,168,14,181,101,187,153,123,140,58,110,9,40,183,249,229,223,216,81,152,98,151,110,192,236,80,103,161,100];
      const seed2 = [75,5,181,210,168,14,181,101,187,153,123,140,58,110,9,40,183,249,229,223,216,81,152,98,151,110,192,236,80,103,161,99];
      const keys = tonweb.utils.keyPairFromSeed(new Uint8Array(seed));
      const keys2 = tonweb.utils.keyPairFromSeed(new Uint8Array(seed2));
      const wallet = tonweb.wallet.create(keys);
      const wallet2 = tonweb.wallet.create(keys2);
      
      console.log(keys);
      
      window.keys = keys;
      window.keys2 = keys2;
      
      let requests = [];
      let last_finish = 0;
      setInterval(() => {
        if (requests.length && Date.now() - last_finish > 1600) {
          const req = requests.pop();
          console.log(req);
          
          last_finish = Date.now() + 86400 * 1000;
          req.fn(...req.args).then((...args) => {
            last_finish = Date.now();
            
            return req.onresult(...args);
          }, () => {last_finish = Date.now();});
        }
      }, 100);
      
      function update_wallet_info() {
        wallet.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info').innerText = 'Баланс: ' + v / 1000000000;
            }
          })
        });
      }
      
      function update_wallet_info2() {
        wallet2.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info2').innerText = 'Баланс 2: ' + v / 1000000000;
            }
          })
        });
      }
      
      async function pay(target, seq = null, amt = null, payload = null, w = 1) {
        if (seq == null) {
          console.debug("Acquiring sequence number...");
          seq = await (w == 1 ? wallet : wallet2).methods.seqno().call();
          await (new Promise(resolve => setTimeout(resolve, 1200)));
        }
        
        amt = amt || '0.1';
        
        let kp = (w == 1 ? keys : keys2);
        
        return (w == 1 ? wallet : wallet2).methods.transfer({
          secretKey: kp.secretKey,             toAddress: target,
          amount:    tonweb.utils.toNano(amt), seqno:     seq,
          sendMode:  3,                        payload}).send();
      }
      
      class Timer extends tonweb.Contract {
        constructor(provider, options) {
          // build/boc/contract-timer.hex
          options.code = tonweb.boc.Cell.oneFromBoc('B5EE9C7201021C010004AD000114FF00F4A413F4BCF2C80B01020120020302014804050002F20202CB0607020120161704C1D007434C0FE900C234219FE4420404400000000000000000000000000000000000000000000000000000003148431C16517C13C0478005C6C2497C0F80875D270482497C0F80074C7C8608401FAF2316EB8C08860843505B703EEB8C0A244F1C1608090A0B029BA0F6A268698F90FC11DDC75798E98000E0007968414108399DF043B8400C64658281FD201809E78B410802FAF0807D010965B5658FED9E64B87D80474498420FDCC7416D9E6F7140805A7F1018401415027831325202DB3CED44D0D31F22D70B1F12BDF2D078D30001C000F2D07901D31F30C8CB1F01FA405214C705F2D07ACF1601D459CF1401CF16C9ED54DB3C0C15028431325202DB3CED44D08020D721D30001F2E07EFA4003C705F2E07F20841F01D300018E8D31FA40318040D721D31F30DB3C9130E202D43002C8CB1F01CF16CCC9ED540C1500438002B7C7862E322201377988E7A0FB1F8579818E325FDA446EE33B44ADC0FF4F291002FE8EC76C12AA1F01D31F30A020C0018E8330DB3CE0708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1658FA02CB6AC970FB00E08210F5431AA5BDF2D08CD31FD33F218208989680B9F2D06482081B8CF47024F823A1B609A822A0821017D78400A014B9F2D065833F150D01E8D30001C000955BF2C0726DE001D30A018309BDF2D06E01D4D4ED44D022F90001D430F900BDF2D0725222DB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F82812C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED3000197FA40318060D721DE30130186F81103FA40D430DB3C708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1682100BEBC200FA02CB6AC971FB000E0394ED44D0D31F5315B60802841FBA8E82DB3CDED47103C8CB1F13CB0002D30001C0018E9F30830958CB0AF8287F285158051048103741705208DB3C58CBFF13CB3FCB1FE30D01CF14C9ED54150F10011070C8CB01C959DB3C1102B2FA40D33F5391BAF2D12C5319BC8EC8C801D31F305309B98E107158CB005003CF16CB3FCB1F7001CB009C7158CB015003CF16CB3FCB1FE283095003CB0AF82803C97F2951690610591048542393DB3C01CBFF13CB3FCB1FE30D1112019408C8CB3F17CB1F5250CB3F5004CF1612CC01CF165210CCCCC958DB3C7621F90083098010C8CB05CB0ACBFF0382100BEBC200A024B013FA0212CB6B5210CCC9804003B313B012FB00F90013017A5142CF16CB3F5003CF168210FBFFAB22708018C8CB055005CF162782100BEBC200A0FA0214CB6A13CB1F17CB3F15CB1F13CB3F01CF16CCDB3CC970FB0014000E76C8CB04CCCCC90014ED44D0D4307058CB00CC0074708018C8CB058D0867F9108101100000000000000000000000000000000000000000000000000000000CCF1682101DCD6500FA02CB6AC970FB000201201819001DBC82DBFB836C10085AEF6A1EC45814001FB8B5D316EF2E0646D70C8CB01F400C980201201A1B0027B5D2DDA89A10041AE43A6000327F48061C060DB00017B4F47061391961597FF93A10');
          super(provider, options);
        }
        
        createDataCell() {
          const cell = new tonweb.boc.Cell();
          cell.bits.writeUint(0xFFFFFFFF, 32);  //  no scheduled messages
          cell.bits.writeUint(0, 1);            //  no bells
          
          // build/boc/contract-bell.hex
          cell.refs.push(tonweb.boc.Cell.oneFromBoc('B5EE9C720102290100068F000114FF00F4A413F4BCF2C80B0102016202030202CC04050201200B0C0295D9910E38048ADF068698180B8D848ADF000E98F90C108399DF043DD4E9880FD201800C10093A676A1EC478F10C1087DFFD5915D474918E99FE98FE99FFD206A037D20182AA86D9E71877141E06020120070803D821821096F5C875BA9D3101FA4030018201B172ED43D88FD321821004DED148BA8E8E6C21D33FFA40D4D300305502DB3C8F38218210D0C3BFEABA8E9131D33FFA40D4D3003004FA40304430DB3C8E9A0182102FCB26A2BA8E8AD33F3001FA403001DB3C945BF2C194E2E2E2E21613140029F4184B8E4658065850A65FF89659FE58F80E78B64C020148090A002520C25C540172C00532C284B2FFF2CFF2C7F26000213B513420402835C87E900C750C7E900C200201200D0E02012017180201200F100105BA687816020158111203D7B4E9841AE1600A445B679DA89A10081AE43A63FA67FF481A9F48063A861A1A6000380031D4E6CBE08650420E677C10EE1003191960A07F48060279E2C45F4042596D5963E03B679930081F601C1F046A00B73E5A0C8E3002191960AA0079E2CA007F40596D59992E1F6000501F23150105AEA8C0130105AF70C014008CF828FA44317082100DD607E3218018C8CB055009CF1622FA0218CB6A17CB1F13CB3F12CBFF01CF16F00DCF1612CC12CB3F01987101CB00ED4401CC947001CB00E2C98040FB000056F828FA443182108B771735708018C8CB055005CF1624FA0214CB6A13CB1FCB3FCBFFF00DCF16C98040FB00029E8EA5821096F5C875708010C8CB055005CF1624FA0214CB6A13CB1F58DB3C01CF16C98100A0FB008EA58210D416DC0F708010C8CB055005CF1624FA0214CB6A13CB1F58DB3C01CF16C98100A0FB00E223230084F828FA44317082100F24C7AE218018C8CB055008CF1622FA0217CB6A16CB1F12CB3FCBFFF00DCF1612CC12CB3F01987101CB00ED44CF14947001CB00E2C98040FB00020120191A0201201C1D001DB5F9FF051F48863E01AFEA82440DB003F9B62E4CDB67803A60003E5C325A803A003A863DA89A1904409AE16BF083F6045AE16BF083F600BA600031C2BF480630081AE4241AE163E2D73E5A32609AE163E092261C504200FD7918AE1002191960BE01B9E2C43F40596D5963EA00DB6782B963E27963F92E1F60003A73E07973E05F480A0679E2C05A8A0679E280501F231B0054FA405033CF1602D401D0D3000197FA40318060D721DEC85003CF1658CF16C912CF1401D430CF14C9ED540105B79CB01E0075B46FDDA89A10081AE43A9A803A11605160405A600032E63F48100C1AE43BDA600032CD825F48060032261C405A63FA67FF481F48060206C80AA090037E5065DB3CED44D0D33F5252BCF2D06423F823B9F2D0656D01D401D001D31F305250B9E30F206EB38E13ED44D0D4D431D4C801CF1612CC12CCCCC9ED549130E21F202101D4D30001C0009AF00D12C705F2E072D430E001D30A018309BDF2D06E01D4D4305CDB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F00D12C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED3000197FA40318060D721DE302803C2D30001C0008E9531F00D702651600605104A10394909DB3C5023F00B8F42FA4020D70B3F5270BC8EB5308210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE226232203D8C801D30001C000947058CB008E107158CB0001FA4059CF1601D35F02CB5FE201D30001C0008F43FA4020D70B3F5280BC8EB630318210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE30D232425018832C822D70B5F841FB05260BB947001CB00DE7101CB0001CF1601D35F02CB5F21D70B5F841FB05250BC947001CB00DEC9F00D702751700706105B104A4A0ADB3C5023F00B2700527158CB00ED44D0D4D39F01C8CB9F01FA4059CF1612CC01FA4059CF1601D431D4305202CCCCC901CCCC018A33C823D70B5F841FB05270BB947001CB00DE7101CB0001CF1602D35F03CB5F02D70B5F841FB05250BC957058CB0001DE01C9F00D702751700706105B104A4A0ADB3C02F00C27012A3031F00D702651600605104A10394909DB3C02F00C26011070C8CB01C959DB3C27019408C8CB3F17CB1F5250CB3F5004CF1612CC01CF165210CCCCC958DB3C7621F90083098010C8CB05CB0ACBFF0382100BEBC200A024B013FA0212CB6B5210CCC9804003B313B012FB00F90028000E76C8CB04CCCCC9'));
          return cell;
        }
        
        async deploy() {
          const {stateInit} = await this.createStateInit();
          
          console.debug("Acquiring sequence number...");
          let seq = await wallet.methods.seqno().call();
          
          await (new Promise(resolve => setTimeout(resolve, 1200)));
          
          await wallet.methods.transfer({
            secretKey: keys.secretKey,             toAddress: await this.getAddress(),
            amount:    tonweb.utils.toNano('1.0'), seqno:     seq,
            sendMode:  0,                          stateInit: stateInit}).send();
        }
      }
      
      const timer = new Timer(tonweb, {});
      
      function update_wallet_info_timer() {
        timer.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info_timer').innerText = 'Баланс таймера: ' + v / 1000000000;
            }
          })
        });
      }
      
      async function deposit() {
        let value = window.prompt('Value to send to timer');
        if (!(+value)) {return;}
        
        await pay(await timer.getAddress(), null, value, null);
      }
      
      async function schedule_message() {
        let wanted_body = new tonweb.boc.Cell();
        wanted_body.bits.writeUint(1, 64);
        wanted_body.bits.writeUint(72, 8);
        wanted_body.bits.writeUint(101, 8);
        wanted_body.bits.writeUint(108, 8);
        wanted_body.bits.writeUint(108, 8);
        wanted_body.bits.writeUint(111, 8);
        
        let ds = 60;
        let time = Math.floor((new Date()).getTime() / 1000);
        let wanted_time = time + ds;
        
        console.log(new Date());
        console.log('Scheduling at', time, 'to', wanted_time);
        
        let wanted_to = new tonweb.boc.Cell();
        
        let request = new tonweb.boc.Cell();
        request.bits.writeUint(0xf5431aa5, 32);
        request.bits.writeUint(wanted_time, 32);
        request.bits.writeUint(10000000, 64);     // forwarded amount
        request.bits.writeAddress(await wallet.getAddress());
        request.refs.push(wanted_body);
        
        let required_nanotons = ds * 1805556 + 400000000 + 10000000;
        required_nanotons += 200 * 1000 * 1000;  // adding network fees
        let required_tons = Math.floor(required_nanotons / 1000000000) + '.'
                          + (required_nanotons % 1000000000);
        
        console.log('Using', required_tons, 'TON');
        
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        await pay(await wallet2.getAddress(), null, '' + required_tons);
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        await pay(await timer.getAddress(), null, '' + required_tons, request, 2);
      }
      
      async function schedule_batch() {
        let wanted_body = new tonweb.boc.Cell();
        wanted_body.bits.writeUint(1, 64);
        wanted_body.bits.writeUint(84, 8);
        wanted_body.bits.writeUint(73, 8);
        wanted_body.bits.writeUint(77, 8);
        wanted_body.bits.writeUint(69, 8);
        wanted_body.bits.writeUint(82, 8);
        wanted_body.bits.writeUint(45, 8);
        wanted_body.bits.writeUint(66, 8);
        wanted_body.bits.writeUint(65, 8);
        wanted_body.bits.writeUint(84, 8);
        wanted_body.bits.writeUint(67, 8);
        wanted_body.bits.writeUint(72, 8);
        
        let ds = 5 * 60 - 10;
        
        let required_nanotons = ds * 1805556 + 400000000 + 10000000;
        required_nanotons += 200 * 1000 * 1000;  // adding network fees
        let required_tons = Math.floor(required_nanotons / 1000000000) + '.'
                          + (required_nanotons % 1000000000);
        
        let batch_required_nt = required_nanotons * 5;
        let batch_required_t = Math.floor(batch_required_nt / 1000000000) + '.'
                             + (batch_required_nt % 1000000000);
        
        console.log('Transfer', batch_required_t, 'to', await wallet2.getAddress());
        console.log('pay(await wallet2.getAddress(), null, "' + batch_required_t + '").then(continue_batch.resolve);');
        
        await new Promise((resolve, reject) => {
          window.continue_batch = {resolve, reject};
        });
        
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        let seqno_wallet2 = await wallet2.methods.seqno().call();
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        
        for (let i = 0; i < 5; i++) {
          let wanted_time = Math.floor((new Date()).getTime() / 1000) + i + ds;
          let request = new tonweb.boc.Cell();
          request.bits.writeUint(0xf5431aa5, 32);
          request.bits.writeUint(wanted_time, 32);
          request.bits.writeUint(10000000, 64);     // forwarded amount
          request.bits.writeAddress(await wallet.getAddress());
          request.refs.push(wanted_body);
          
          await pay(await timer.getAddress(), seqno_wallet2 + i,
                    required_tons, request, 2);
          console.log('Message #', i, 'scheduled successfully');
          
          await (new Promise(resolve => setTimeout(resolve, 19800)));
        }
      }
      
      function schedule_batch_wrapper() {
        return schedule_batch()
          .then(() => {console.log('All messages scheduled');},
                (e) => {console.error('Scheduling error:', e);});
      }
      
      async function withdraw() {
        let amount = +window.prompt('NanoTONs to pull');
        if (!amount) {return;}
        
        let body = new tonweb.boc.Cell();
        body.bits.writeUint(amount, 64);
        
        await pay(await timer.getAddress(), null, '0.05', body);
      }
      
      async function start_loop() {
        let body = new tonweb.boc.Cell();
        body.bits.writeUint(1, 64);
        await pay(await timer.getAddress(), null, '0.05', body);
      }
      
      function dump_stores(bits) {
        let s = '';
        while (bits.length >= 256) {
          s += '.store_uint(0x' + tonweb.utils.bytesToHex(bits.array.slice(0, 32)) + ', 256)';
          bits.array = bits.array.slice(32);
          bits.length -= 256;
        }
        s += '.store_uint(0x' + tonweb.utils.bytesToHex(bits.array) + ' >> ' +
          (bits.length - bits.cursor % 256) + ', ' + bits.cursor % 256 + ')';
        return s;
      }
      
      function dump_cell(cell, i = 1, s = '') {
        let orig = i;
        s += '  var b' + i + ' = begin_cell()' + dump_stores(cell.bits) + ';\n';
        
        for (let j = 0; j < cell.refs.length; j++) {
          let k = ++i;
          [i, s] = dump_cell(cell.refs[j], i, s);
          s += '  b' + orig + ' = b' + orig + '.store_ref(b' + k + '.end_cell());\n';
        }
        
        return [i, s];
      }
      
      // timer.deploy().then(console.log)
      // iem.message.print()
      // wallet.deploy(keys.secretKey).getQuery().then((b) => console.log(b.print()))
      
      // timer.getAssociatedUSDQWallet().then(console.log)
    </script>
  </head>
  <body>
    <p id="address">Адрес: ?</p>
    <p id="wallet_info">Баланс: ?</p>
    <button onclick="update_wallet_info();">Обновить данные кошелька</button>
    
    <p id="address2">Адрес 2: ?</p>
    <p id="wallet_info2">Баланс 2: ?</p>
    <button onclick="update_wallet_info2();">Обновить данные кошелька 2</button>
    
    
    <p id="address_timer">Адрес таймера: ?</p>
    <p id="wallet_info_timer">Баланс таймера: ?</p>
    <button onclick="deposit();">Пополнить баланс таймера</button>
    <button onclick="withdraw();">Снять TON с таймера</button>
    <button onclick="timer.deploy();">Развернуть контракт таймера</button>
    <button onclick="update_wallet_info_timer();">Обновить баланс контракта таймера</button>
    <button onclick="schedule_message();">Запланировать отправку сообщения</button>
    <button onclick="schedule_batch_wrapper()">Запланировать множество сообщений</button>
    <button onclick="start_loop();">Начать цикл таймера</button>
    
    <script>
      (async () => {
        let addr = await wallet.getAddress();
        document.getElementById('address').innerText = 'Адрес: ' + addr.toString(true, true, true);
        
        let addr2 = await wallet2.getAddress();
        document.getElementById('address2').innerText = 'Адрес 2: ' + addr2.toString(true, true, true);
        
        let timer_addr = await timer.getAddress();
        document.getElementById('address_timer').innerText = 'Адрес таймера: ' + timer_addr.toString(true, true, true);
      })();
    </script>
  </body>
</html>