<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb.min.js?v=1.1.41"></script>
    <script type="text/javascript" src="https://wallet.ton.org/libs/tonweb-mnemonic.min.js?v=1.1.41"></script>
    
    <script>
      const tonweb = new TonWeb(
        new TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC')
      );
      
      // Intentional secret leakage.
      // This seed can only be used for testing timer.
      const seed  = [75,5,181,210,168,14,181,101,187,153,123,140,58,110,9,40,183,249,229,223,216,81,152,98,151,110,192,236,80,103,161,100];
      const seed2 = [75,5,181,210,168,14,181,101,187,153,123,140,58,110,9,40,183,249,229,223,216,81,152,98,151,110,192,236,80,103,161,99];
      const keys = tonweb.utils.keyPairFromSeed(new Uint8Array(seed));
      const keys2 = tonweb.utils.keyPairFromSeed(new Uint8Array(seed2));
      const wallet = tonweb.wallet.create(keys);
      const wallet2 = tonweb.wallet.create(keys2);
      
      console.log(keys);
      
      window.keys = keys;
      window.keys2 = keys2;
      
      let requests = [];
      let last_finish = 0;
      setInterval(() => {
        if (requests.length && Date.now() - last_finish > 1600) {
          const req = requests.pop();
          console.log(req);
          
          last_finish = Date.now() + 86400 * 1000;
          req.fn(...req.args).then((...args) => {
            last_finish = Date.now();
            
            return req.onresult(...args);
          }, () => {last_finish = Date.now();});
        }
      }, 100);
      
      function update_wallet_info() {
        wallet.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info').innerText = 'Баланс: ' + v / 1000000000;
            }
          })
        });
      }
      
      function update_wallet_info2() {
        wallet2.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info2').innerText = 'Баланс 2: ' + v / 1000000000;
            }
          })
        });
      }
      
      async function pay(target, seq = null, amt = null, payload = null, w = 1) {
        if (seq == null) {
          console.debug("Acquiring sequence number...");
          seq = await (w == 1 ? wallet : wallet2).methods.seqno().call();
          await (new Promise(resolve => setTimeout(resolve, 1200)));
        }
        
        amt = amt || '0.1';
        
        let kp = (w == 1 ? keys : keys2);
        
        return (w == 1 ? wallet : wallet2).methods.transfer({
          secretKey: kp.secretKey,             toAddress: target,
          amount:    tonweb.utils.toNano(amt), seqno:     seq,
          sendMode:  3,                        payload}).send();
      }
      
      class Timer extends tonweb.Contract {
        constructor(provider, options) {
          // build/boc/contract-timer.hex
          options.code = tonweb.boc.Cell.oneFromBoc('B5EE9C720102180100043F000114FF00F4A413F4BCF2C80B01020120020302014804050034F2F8276F223020820AFAF080BC01821005F5E100B9B092F800DE0202CB0607020120141503F5D007434C0FE900C234219FE4420404400000000000000000000000000000000000000000000000000000003148431C16517C13C04B8005C6C2497C0F80875D270482497C0F80875C2C7E08401FAF2316EB8C0A34218002B7C7862E322201377988E7A0FB1F8579818E325FDA446EE33B44ADC0FF4F29131C178C0A08090A029BA176A268698F90FC11DDC75798E98000E0007968414108399DF043B8400C64658281FD201809E78B410802FAF0807D010965B5658FED9E64B87D80474498420FDCC7416D9E6F7140805A7F1018401213027232D31F315210DB3CED44D0D31F22D70B1F12BDF2D078D30001C000F2D07901D31F3001FA40305203C7056C1296841FBDF2D07A8E8330DB3CE20B1301B431D33F3020C0018E8330DB3CE0F8276F2230841FF823A15112A182083719E758A8B9F2D069708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1658FA02CB6AC970FB001301F6D31F018210F5431AA5BDF2D08CD31FD33F218208989680B9F2D06482081B8CF47024F823A1B609A822A0821017D78400A014B9F2D065833FF81103FA40D430DB3C708018C8CB058D086000ADF1E18B8C88804DDE6239E83EC7E15E60638C97F6911BB8CED12B703FD3CA44CF1682100BEBC200FA02CB6AC971FB000C01D4D30001C000955BF2C0726DE001D30A018309BDF2D06E01D4D4ED44D022F90001D430F900BDF2D0725222DB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F82812C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED30030110388ED44D0D31F5315B60802841FBA8E82DB3CDED47103C8CB1F13CB0002D30001C0018E9B30830958CB0AF828275147041037461626DB3C58CBFF13CB3FCB1FE30DCCC9ED54130D0E011070C8CB01C901DB3C0F02B0FA40D33F5391BAF2D12C5319BC8EC7C801D31F305309B98E107158CB005003CF16CB3FCB1F7001CB009C7158CB015003CF16CB3FCB1FE283095003CB0AF82803C92851580510481037541028DB3C01CBFF13CB3FCB1FE30D0F10016E07C8CB3F16CB1F14CB3F58CF16CC01CF165210CCCCC901DB3C7621F90083098010C8CB05CB0ACBFF70FA02CB6B5210CCC98040FB00F90011016E5142CF16CB3F5003CF168210FBFFAB22708018C8CB055005CF1624FA0214CB6A13CB1F17CB3F15CB1F13CB3F01CF16CCDB3CC98040FB0012000E76C8CB04CCCCC90014ED44D0D4307058CB00CC0074708018C8CB058D0867F9108101100000000000000000000000000000000000000000000000000000000CCF1682101DCD6500FA02CB6AC970FB000201201617001DBC82DBFB836C10085AEF6A1EC45814001FB8B5D316EF2E0646D70C8CB01F400C980017BA7A38309C8CB0ACBFFC9D08');
          super(provider, options);
        }
        
        createDataCell() {
          const cell = new tonweb.boc.Cell();
          cell.bits.writeUint(0xFFFFFFFF, 32);  //  no scheduled messages
          cell.bits.writeUint(0, 1);            //  no bells
          
          // build/boc/contract-bell.hex
          cell.refs.push(tonweb.boc.Cell.oneFromBoc('B5EE9C72010225010005D4000114FF00F4A413F4BCF2C80B0102016202030202CC04050201200A0B01CDD9910E38048ADF068698180B8D848ADF000E98F90C108399DF043DD4E9880FD201800C10093A676A1EC475D10C1087DFFD5915D474918E99FE98FE99FFD206A037D20182AA86D9E470D80C1084B7AE43ADD4E00FD201800C100D8B976A1EC4A2DF960CA71717141B0201580607020120080900214ED44D08100A0D721FA4031D431FA40308002920C25C7232C032C28532FFC4B2CFF2C7C073C5B260002520C25C540172C00532C284B2FFF2CFF2C7F2600201200C0D02012016170201200E0F0105BA687815020158101103D7B4E9841AE1600A445B679DA89A10081AE43A63FA67FF481A9F48063A861A1A6000380031D4E6CBE08650420E677C10EE1003191960A07F48060279E2C45F4042596D5963E03B679930081F601C1F0464B77E5A0C8E3002191960AA0099E2CA009F4042596D59992E1F6000701C21140105AEA8C0120105AF70C013008CF828FA44317082100DD607E3218018C8CB055009CF1622FA0218CB6A17CB1F13CB3F12CBFF01CF16F00ECF1612CC12CB3F01987101CB00ED4401CC947001CB00E2C98040FB000056F828FA443182108B771735708018C8CB055005CF1624FA0214CB6A13CB1FCB3FCBFFF00ECF16C98040FB0002A88EA630821096F5C875708010C8CB055005CF1624FA0214CB6A13CB1F58DB3C01CF16C98100A0FB008EA932841F821007EBC8C5708010C8CB055006CF1625FA0215CB6A14CB1F01DB3CCB1FCB1FC98100A0FB00E221210090F828FA44317082102233223382100F24C7AE228018C8CB055008CF1623FA0217CB6A16CB1F15CB3FCBFFF00ECF1612CC12CB3F01987101CB00ED4401CC947001CB00E2C98040FB0002012018190105B9CE581B001DB5F9FF051F48863E01CFEA82440DB003F9B62E4CDB67803A60003E5C325A803A003A863DA89A1904409AE16BF083F6045AE16BF083F600BA600031C2BF480630081AE4241AE163E2D73E5A32609AE163E092261C504200FD7918AE1002191960BE01D9E2C43F40596D5963EA00DB6782B963E27963F92E1F60003A73E07973E05F480A0679E2C05A8079805F48101C211A004E5033CF1602D401D0D3000197FA40318060D721DEC85003CF1658CF16C958CC01D43001CCC9ED54037E5065DB3CED44D0D33F5252BCF2D06423F823B9F2D0656D01D401D001D31F305250B9E30F206EB38E13ED44D0D4D431D4C801CF1612CC12CCCCC9ED549130E21C1D1E01C0D30001C0009AF00E12C705F2E072D430E001D30A018309BDF2D06E01D4D4305CDB3C03D3FF3003F90013BDF2D06FD08100A0D721FA4031D431FA40F00E12C705F2E070D4D43021F90001F900BDF2D071D0D3000197FA40318060D721DED300302403BCD30001C0008E9231F00E255150050410394880DB3C5023F00C8F42FA4020D70B3F5270BC8EB5308210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE220211F03FEC801D30001C000947058CB008E107158CB0001FA4059CF1601D35F02CB5FE201D30001C0008E923031F00E255150050410394880DB3C02F00D8F43FA4020D70B3F5280BC8EB630318210FBFFAB22708010C8CB055003CF1625821005F5E100A0FA0212CB6ACB1F15CB3F13CB1FCB3F5004CF1612CC58DB3CC970FB00E30DE2202122018232C822D70B5F841FB05260BB947001CB00DE7101CB0001CF1601D35F02CB5F21D70B5F841FB05250BC947001CB00DEC9F00E2651600605104A1913DB3C5023F00C23011070C8CB01C901DB3C2300527158CB00ED44D0D4D39F01C8CB9F01FA4059CF1612CC01FA4059CF1601D431D4305202CCCCC901CCCC018433C823D70B5F841FB05270BB947001CB00DE7101CB0001CF1602D35F03CB5F02D70B5F841FB05250BC957058CB0001DE01C9F00E2651600605104A1913DB3C02F00D23016E07C8CB3F16CB1F14CB3F58CF16CC01CF165210CCCCC901DB3C7621F90083098010C8CB05CB0ACBFF70FA02CB6B5210CCC98040FB00F90024000E76C8CB04CCCCC9'));
          return cell;
        }
        
        async deploy() {
          const {stateInit} = await this.createStateInit();
          
          console.debug("Acquiring sequence number...");
          let seq = await wallet.methods.seqno().call();
          
          await (new Promise(resolve => setTimeout(resolve, 1200)));
          
          await wallet.methods.transfer({
            secretKey: keys.secretKey,             toAddress: await this.getAddress(),
            amount:    tonweb.utils.toNano('1.0'), seqno:     seq,
            sendMode:  0,                          stateInit: stateInit}).send();
        }
      }
      
      const timer = new Timer(tonweb, {});
      
      function update_wallet_info_timer() {
        timer.getAddress().then((addr) => {
          requests.push({
            'fn': tonweb.getBalance.bind(tonweb),
            'args': [addr],
            'onresult': (v) => {
              document.getElementById('wallet_info_timer').innerText = 'Баланс таймера: ' + v / 1000000000;
            }
          })
        });
      }
      
      async function deposit() {
        let value = window.prompt('Value to send to timer');
        if (!(+value)) {return;}
        
        await pay(await timer.getAddress(), null, value, null);
      }
      
      async function schedule_message() {
        let wanted_body = new tonweb.boc.Cell();
        wanted_body.bits.writeUint(1, 64);
        wanted_body.bits.writeUint(72, 8);
        wanted_body.bits.writeUint(101, 8);
        wanted_body.bits.writeUint(108, 8);
        wanted_body.bits.writeUint(108, 8);
        wanted_body.bits.writeUint(111, 8);
        
        let ds = 60;
        let time = Math.floor((new Date()).getTime() / 1000);
        let wanted_time = time + ds;
        
        console.log(new Date());
        console.log('Scheduling at', time, 'to', wanted_time);
        
        let wanted_to = new tonweb.boc.Cell();
        
        let request = new tonweb.boc.Cell();
        request.bits.writeUint(0xf5431aa5, 32);
        request.bits.writeUint(wanted_time, 32);
        request.bits.writeUint(10000000, 64);     // forwarded amount
        request.bits.writeAddress(await wallet.getAddress());
        request.refs.push(wanted_body);
        
        let required_nanotons = ds * 1805556 + 400000000 + 10000000;
        let required_tons = required_nanotons / 1000000000 + 2 / 5;  // adding network fees
        
        console.log('Using', required_tons, 'TON');
        
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        await pay(await wallet2.getAddress(), null, '' + (required_tons + 1 / 100));
        await (new Promise(resolve => setTimeout(resolve, 1200)));
        await pay(await timer.getAddress(), null, '' + required_tons, request, 2);
      }
      
      async function withdraw() {
        let amount = +window.prompt('NanoTONs to pull');
        if (!amount) {return;}
        
        let body = new tonweb.boc.Cell();
        body.bits.writeUint(amount, 64);
        
        await pay(await timer.getAddress(), null, '0.05', body);
      }
      
      async function start_loop() {
        let body = new tonweb.boc.Cell();
        body.bits.writeUint(1, 64);
        await pay(await timer.getAddress(), null, '0.05', body);
      }
      
      function dump_stores(bits) {
        let s = '';
        while (bits.length >= 256) {
          s += '.store_uint(0x' + tonweb.utils.bytesToHex(bits.array.slice(0, 32)) + ', 256)';
          bits.array = bits.array.slice(32);
          bits.length -= 256;
        }
        s += '.store_uint(0x' + tonweb.utils.bytesToHex(bits.array) + ' >> ' +
          (bits.length - bits.cursor % 256) + ', ' + bits.cursor % 256 + ')';
        return s;
      }
      
      function dump_cell(cell, i = 1, s = '') {
        let orig = i;
        s += '  var b' + i + ' = begin_cell()' + dump_stores(cell.bits) + ';\n';
        
        for (let j = 0; j < cell.refs.length; j++) {
          let k = ++i;
          [i, s] = dump_cell(cell.refs[j], i, s);
          s += '  b' + orig + ' = b' + orig + '.store_ref(b' + k + '.end_cell());\n';
        }
        
        return [i, s];
      }
      
      // timer.deploy().then(console.log)
      // iem.message.print()
      // wallet.deploy(keys.secretKey).getQuery().then((b) => console.log(b.print()))
      
      // timer.getAssociatedUSDQWallet().then(console.log)
    </script>
  </head>
  <body>
    <p id="address">Адрес: ?</p>
    <p id="wallet_info">Баланс: ?</p>
    <button onclick="update_wallet_info();">Обновить данные кошелька</button>
    
    <p id="address2">Адрес 2: ?</p>
    <p id="wallet_info2">Баланс 2: ?</p>
    <button onclick="update_wallet_info2();">Обновить данные кошелька 2</button>
    
    
    <p id="address_timer">Адрес таймера: ?</p>
    <p id="wallet_info_timer">Баланс таймера: ?</p>
    <button onclick="deposit();">Пополнить баланс таймера</button>
    <button onclick="withdraw();">Снять TON с таймера</button>
    <button onclick="timer.deploy();">Развернуть контракт таймера</button>
    <button onclick="update_wallet_info_timer();">Обновить баланс контракта таймера</button>
    <button onclick="schedule_message();">Запланировать отправку сообщения</button>
    <button onclick="start_loop();">Начать цикл таймера</button>
    
    <script>
      (async () => {
        let addr = await wallet.getAddress();
        document.getElementById('address').innerText = 'Адрес: ' + addr.toString(true, true, true);
        
        let addr2 = await wallet2.getAddress();
        document.getElementById('address2').innerText = 'Адрес 2: ' + addr2.toString(true, true, true);
        
        let timer_addr = await timer.getAddress();
        document.getElementById('address_timer').innerText = 'Адрес таймера: ' + timer_addr.toString(true, true, true);
      })();
    </script>
  </body>
</html>